# 3. API 제작

[TOC]



### 0️⃣ 개요

**사용기술**

- 언어 - typescript

- 프레임워크 - nest.js
- ORM - typeorm
- 데이터베이스 - postgresql
- 프론트 - graphql



**이전**

- nest.js 백엔드 서버 세팅
  - DB연결, 디렉토리 구조 세팅

- 데이터베이스 스키마 구축
  - ERD 제작 (erdcloud)
  - 엔티티 생성



**목표**

- API 본격 개발
  - 회원가입, 로그인
  - api개발




**이후**

- 프론트 개발





### 1️⃣ 회원가입 개발



















### , 로그인 개발

1. Jwt 모듈 설치

- ```shell
  npm install --save @nestjs/jwt
  ```



2. JWT 모듈 등록

- ```typescript
  import { Module } from '@nestjs/common';
  import { JwtModule } from '@nestjs/jwt';
  
  @Module({
    imports: [
      JwtModule.register({
        secret: 'your-secret-key',
        signOptions: { expiresIn: '1h' }, // Optional: 토큰 만료 시간
      }),
    ],
  })
  export class AppModule {}
  ```



3. AuthGuard 생성

- passport 설치 및 등록

  - ```shell
    npm install --save @nestjs/passport
    ```

  - ```typescript
    /* app.module.ts */
    import { PassportModule } from '@nestjs/passport';
    
    @Module({
        imports: [
            /* ... */
            PassportModule,
            UserModule,
        ],
    })
    ```

- Jwt Guard 생성

  - ```typescript
    import { Injectable } from '@nestjs/common';
    import { AuthGuard } from '@nestjs/passport';
    
    @Injectable()
    export class JwtAuthGuard extends AuthGuard('jwt') {
        
    }
    ```



4. JWT Strategy 생성

- passport-jwt 설치

  - ```shell
    npm install @types/passport-jwt
    ```

- JWT Strategy 생성

  - ```typescript
    import { Injectable } from '@nestjs/common';
    import { PassportStrategy } from '@nestjs/passport';
    import { Strategy, ExtractJwt } from 'passport-jwt';
    import { AuthService } from './auth.service';
    
    @Injectable()
    export class JwtStrategy extends PassportStrategy(Strategy) {
      constructor(private readonly authService: AuthService) {
        super({
          jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
          secretOrKey: 'your-secret-key',
        });
      }
    
      async validate(payload: any) {
        return this.authService.validateUser(payload);
      }
    }
    ```



5. Auth Service 생성

- bcrypt 설치

  - ```typescript
    npm install --save bcrypt
    ```



- AuthService

  - ```typescript
    import { Injectable } from '@nestjs/common';
    import { JwtService } from '@nestjs/jwt';
    
    @Injectable()
    export class AuthService {
      constructor(private readonly jwtService: JwtService) {}
    
      async validateUser(payload: any) {
        // 실제로는 데이터베이스에서 사용자를 찾아 반환
        return { userId: payload.sub, username: payload.username };
      }
    
      async login(user: any) {
        const payload = { username: user.username, sub: user.userId };
        return {
          access_token: this.jwtService.sign(payload),
        };
      }
    }
    ```

